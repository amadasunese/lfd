{% extends "base.html" %}

{% block title %}Shopping Cart - Lauracious Foodies Delight{% endblock %}

{% block content %}
<div class="container">
  <h1 class="mb-4">Shopping Cart</h1>

  {% if session.get('cart') and session.cart|length > 0 %}
    <div class="row">
      <div class="col-lg-8">
        <div class="card mb-3">
          <div class="card-body p-0">
            <table class="table mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th scope="col">Item</th>
                  <th scope="col" class="text-end">Unit Price</th>
                  <th scope="col" class="text-center">Qty</th>
                  <th scope="col" class="text-end">Subtotal</th>
                  <th scope="col" class="text-center">Action</th>
                </tr>
              </thead>
              <tbody class="table-light">
                {% set items_subtotal = namespace(value=0) %}
                {% for item_id, item in session.cart.items() %}
                  <tr>
                    <td style="min-width: 220px;">
                      <div class="d-flex align-items-center">
                        {% if item.image %}
                          <img src="{{ item.image }}" alt="{{ item.name }}" class="me-3 rounded" style="width:64px; height:64px; object-fit:cover;">
                        {% endif %}
                        <div>
                          <div class="fw-semibold">{{ item.name }}</div>
                          {% if item.description %}
                            <small class="text-muted d-block">{{ item.description }}</small>
                          {% endif %}
                        </div>
                      </div>
                    </td>

                    <td class="text-end">₦{{ "%.2f"|format(item.price) }}</td>

                    <td class="text-center">
                      <form method="POST" action="{{ url_for('orders.update_cart') }}" class="d-inline-flex align-items-center">
                        <input type="hidden" name="item_id" value="{{ item_id }}">
                        <div class="input-group input-group-sm" style="width:120px;">
                          <input
                            type="number"
                            name="quantity"
                            class="form-control"
                            value="{{ item.quantity }}"
                            min="1"
                            max="99"
                            aria-label="Quantity for {{ item.name }}"
                            required>
                          <button type="submit" class="btn btn-outline-secondary" title="Update quantity">Update</button>
                        </div>
                      </form>
                    </td>

                    <td class="text-end">₦{{ "%.2f"|format(item.price * item.quantity) }}</td>

                    <td class="text-center">
                      <form method="POST" action="{{ url_for('orders.remove_from_cart') }}" class="d-inline">
                        <input type="hidden" name="item_id" value="{{ item_id }}">
                        <button type="submit" class="btn btn-danger btn-sm" aria-label="Remove {{ item.name }}">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </td>
                  </tr>

                  {% set items_subtotal.value = items_subtotal.value + (item.price * item.quantity) %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="d-flex gap-2">
          <a href="{{ url_for('menu.menu') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Continue shopping
          </a>

          <form method="GET" action="{{ url_for('orders.checkout') }}">
            <button type="submit" class="btn btn-primary">
              Proceed to checkout <i class="fas fa-credit-card ms-1"></i>
            </button>
          </form>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Order summary</h5>
            <hr>
            <div class="d-flex justify-content-between mb-2">
              <span>Items subtotal</span>
              <span class="fw-semibold">₦{{ "%.2f"|format(items_subtotal.value) }}</span>
            </div>

            <div class="alert alert-secondary small mb-3">
              Delivery fee and 7.5% VAT will be calculated at checkout based on your delivery area.
            </div>

            <div class="d-grid gap-2">
              <a href="{{ url_for('orders.checkout') }}" class="btn btn-primary w-100">
                Checkout
              </a>
              <a href="{{ url_for('menu.menu') }}" class="btn btn-outline-secondary w-100">
                Continue shopping
              </a>
            </div>
          </div>
        </div>

        <!-- Optional: show saved address if available -->
        {% if current_user.is_authenticated and current_user.address %}
          <div class="card mt-3">
            <div class="card-body small">
              <strong>Saved address</strong>
              <p class="mb-0">{{ current_user.address }}</p>
              <a href="{{ url_for('main.profile') }}" class="small d-inline-block mt-2">Edit address</a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

  {% else %}
    <div class="alert alert-info text-center">
      <h4 class="mb-1">Your cart is empty</h4>
      <p class="mb-3">Browse our delicious menu and add some items to your cart.</p>
      <a href="{{ url_for('menu.menu') }}" class="btn btn-primary">View menu</a>
    </div>
  {% endif %}
</div>
{% endblock %}
